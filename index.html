<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2E7D32; /* –°—Ç—Ä–æ–≥–∏–π –∑–µ–ª–µ–Ω—ã–π */
            --bg: #F5F5F5;
            --surface: #FFFFFF;
            --border: #E0E0E0;
            --text: #212121;
            --danger: #D32F2F;
            --success: #388E3C;
            --nav-height: 60px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –º–µ–Ω—é */
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface);
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        h2 { margin: 0; font-size: 1.2rem; }
        select {
            padding: 5px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #fff;
            font-size: 1rem;
        }

        /* --- TABS --- */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- CARDS & DASHBOARD --- */
        .card {
            background: var(--surface);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: #FAFAFA;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-val { font-weight: bold; font-size: 1.1rem; display: block; }
        .stat-label { font-size: 0.8rem; color: #666; }

        /* --- TABLES (SHARED STYLES) --- */
        .table-wrapper {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            text-align: center;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        th { background: #E8F5E9; font-weight: 600; font-size: 0.8rem; }
        
        /* STICKY COLUMN 1 */
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: var(--surface);
            z-index: 2;
            border-right: 2px solid #ccc;
            text-align: left;
            min-width: 140px;
            max-width: 160px;
            white-space: normal; /* –ü–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö */
        }
        th:first-child { z-index: 5; background: #E8F5E9; }

        /* --- HABIT SPECIFIC --- */
        .check-btn {
            width: 24px; height: 24px;
            border: 2px solid #ccc;
            border-radius: 4px;
            display: inline-block;
        }
        .check-btn.checked {
            background: var(--primary);
            border-color: var(--primary);
            position: relative;
        }
        .check-btn.checked::after {
            content: '‚úì'; color: white;
            position: absolute; top: -2px; left: 4px;
        }

        /* --- FINANCE SPECIFIC --- */
        .amount-inc { color: var(--success); font-weight: bold; }
        .amount-exp { color: var(--danger); font-weight: bold; }
        .fin-date { font-size: 0.75rem; color: #666; display: block; margin-bottom: 2px; }
        .fin-cat { font-weight: 500; }
        .del-btn { color: #999; border: none; background: none; font-size: 1.2rem; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 999;
        }
        .nav-btn {
            background: none; border: none;
            display: flex; flex-direction: column; align-items: center;
            color: #757575; font-size: 0.7rem;
            width: 50%;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }

        /* --- FAB & MODAL --- */
        .fab {
            position: fixed; bottom: 80px; right: 20px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: none;
            z-index: 90;
        }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white; padding: 20px; width: 85%;
            border-radius: 8px;
        }
        .modal input, .modal select {
            width: 100%; margin-bottom: 10px; padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc; border-radius: 4px;
        }
        .modal-btns { display: flex; gap: 10px; }
        .btn-full { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: bold; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; }

    </style>
</head>
<body>

<header>
    <h2 id="page-title">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
    <select id="monthSelect"></select>
</header>

<div class="container">

    <div id="tab-habits" class="tab-content active">
        <div class="card">
            <div style="font-weight: bold; margin-bottom: 10px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –º–µ—Å—è—Ü</div>
            <div style="height: 150px;"><canvas id="habitChart"></canvas></div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <table id="habitsTable">
                    <thead>
                        <tr id="habitsHeader">
                            <th>–ü–†–ò–í–´–ß–ö–ê</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody id="habitsBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-finance" class="tab-content">
        <div class="card">
            <div style="text-align: center; margin-bottom: 15px;">
                <span style="color:#666; font-size: 0.9rem;">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</span>
                <div style="font-size: 2rem; font-weight: bold;" id="finBalance">0 ‚ÇΩ</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-val amount-inc" id="finInc">+0 ‚ÇΩ</span>
                    <span class="stat-label">–î–æ—Ö–æ–¥</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val amount-exp" id="finExp">-0 ‚ÇΩ</span>
                    <span class="stat-label">–†–∞—Å—Ö–æ–¥</span>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>–î–ê–¢–ê / –ö–ê–¢–ï–ì–û–†–ò–Ø</th>
                            <th>–°–£–ú–ú–ê</th>
                            <th>–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô</th>
                            <th>–£–î–õ.</th>
                        </tr>
                    </thead>
                    <tbody id="financeBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<button class="fab" onclick="handleFab()">+</button>

<div class="modal-overlay" id="modal-habit">
    <div class="modal">
        <h3>–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</h3>
        <input type="text" id="hName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ß—Ç–µ–Ω–∏–µ)">
        <input type="number" id="hGoal" placeholder="–¶–µ–ª—å –¥–Ω–µ–π (–ø–æ —É–º. 30)" value="30">
        <div class="modal-btns">
            <button class="btn-full btn-save" onclick="saveHabit()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn-full btn-cancel" onclick="closeModal('modal-habit')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-finance">
    <div class="modal">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</h3>
        <select id="fType">
            <option value="expense">üî¥ –†–∞—Å—Ö–æ–¥</option>
            <option value="income">üü¢ –î–æ—Ö–æ–¥</option>
        </select>
        <input type="number" id="fAmount" placeholder="–°—É–º–º–∞" inputmode="numeric">
        <input type="text" id="fCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ï–¥–∞, –¢–∞–∫—Å–∏...)">
        <input type="text" id="fComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
        <input type="date" id="fDate">
        <div class="modal-btns">
            <button class="btn-full btn-save" onclick="saveTransaction()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-full btn-cancel" onclick="closeModal('modal-finance')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('habits', this)">
        <span class="nav-icon">üìä</span>
        <span>–¢—Ä–µ–∫–µ—Ä</span>
    </button>
    <button class="nav-btn" onclick="switchTab('finance', this)">
        <span class="nav-icon">üí∞</span>
        <span>–§–∏–Ω–∞–Ω—Å—ã</span>
    </button>
</nav>

<script>
    // --- SETUP ---
    const months = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
    let state = {
        tab: 'habits',
        year: 2026,
        month: new Date().getMonth(),
        habits: JSON.parse(localStorage.getItem('habits_db')) || [],
        finance: JSON.parse(localStorage.getItem('finance_db')) || []
    };

    let chartInstance = null;

    // Defaults
    if(state.habits.length === 0) {
        state.habits = [
            { id: 1, name: "–ß—Ç–µ–Ω–∏–µ", goal: 30, checks: {} },
            { id: 2, name: "–°–ø–æ—Ä—Ç", goal: 15, checks: {} }
        ];
    }

    // --- INIT ---
    window.onload = () => {
        const sel = document.getElementById('monthSelect');
        months.forEach((m, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = m;
            if(i === state.month) opt.selected = true;
            sel.appendChild(opt);
        });
        sel.addEventListener('change', (e) => {
            state.month = parseInt(e.target.value);
            renderAll();
        });

        document.getElementById('fDate').valueAsDate = new Date();
        renderAll();
    };

    function switchTab(tab, btn) {
        state.tab = tab;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('page-title').innerText = tab === 'habits' ? '–ü—Ä–∏–≤—ã—á–∫–∏' : '–ë—é–¥–∂–µ—Ç';
        renderAll();
    }

    function renderAll() {
        if(state.tab === 'habits') renderHabits();
        else renderFinance();
    }

    // --- HABITS LOGIC (TABLE VIEW) ---
    function renderHabits() {
        const key = `${state.year}-${state.month}`;
        const daysInMonth = new Date(state.year, state.month + 1, 0).getDate();
        
        // Header
        const hRow = document.getElementById('habitsHeader');
        let hHTML = `<th>–ü–†–ò–í–´–ß–ö–ê</th>`;
        for(let d=1; d<=daysInMonth; d++) {
            const isToday = (d === new Date().getDate() && state.month === new Date().getMonth());
            hHTML += `<th style="${isToday ? 'background:#C8E6C9' : ''}">${d}</th>`;
        }
        hHTML += `<th>%</th>`;
        hRow.innerHTML = hHTML;

        // Body
        const tbody = document.getElementById('habitsBody');
        tbody.innerHTML = '';
        
        const chartData = Array(daysInMonth).fill(0);

        state.habits.forEach(h => {
            if(!h.checks[key]) h.checks[key] = [];
            const checks = h.checks[key];
            const percent = Math.round((checks.length / h.goal) * 100);

            let row = `<td>${h.name}</td>`;
            for(let d=1; d<=daysInMonth; d++) {
                const isChecked = checks.includes(d);
                if(isChecked) chartData[d-1]++;
                row += `
                    <td>
                        <div class="check-btn ${isChecked ? 'checked' : ''}" 
                             onclick="toggleCheck(${h.id}, ${d})"></div>
                    </td>
                `;
            }
            row += `<td><b>${percent}%</b></td>`;
            tbody.innerHTML += `<tr>${row}</tr>`;
        });

        drawChart(daysInMonth, chartData);
    }

    function toggleCheck(id, day) {
        const key = `${state.year}-${state.month}`;
        const h = state.habits.find(x => x.id === id);
        const idx = h.checks[key].indexOf(day);
        
        if(idx > -1) h.checks[key].splice(idx, 1);
        else h.checks[key].push(day);

        localStorage.setItem('habits_db', JSON.stringify(state.habits));
        renderHabits(); // Fast re-render
    }

    function drawChart(days, data) {
        const ctx = document.getElementById('habitChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length:days}, (_,i)=>i+1),
                datasets: [{
                    label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                    data: data,
                    borderColor: '#2E7D32',
                    backgroundColor: 'rgba(46, 125, 50, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: { y: {beginAtZero: true}, x: {grid: {display:false}} }
            }
        });
    }

    // --- FINANCE LOGIC (TABLE VIEW) ---
    function renderFinance() {
        const tbody = document.getElementById('financeBody');
        tbody.innerHTML = '';
        
        const currentData = state.finance.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === state.month && d.getFullYear() === state.year;
        }).sort((a,b) => new Date(b.date) - new Date(a.date));

        let inc=0, exp=0, total=0;
        
        // Calc Total Balance (All time)
        state.finance.forEach(t => {
            if(t.type === 'income') total += t.amount;
            else total -= t.amount;
        });

        currentData.forEach(t => {
            if(t.type === 'income') inc += t.amount;
            else exp += t.amount;

            const dateStr = new Date(t.date).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'});
            const isInc = t.type === 'income';
            
            tbody.innerHTML += `
                <tr>
                    <td style="text-align:left;">
                        <span class="fin-date">${dateStr}</span>
                        <span class="fin-cat">${t.category}</span>
                    </td>
                    <td class="${isInc ? 'amount-inc' : 'amount-exp'}">
                        ${isInc ? '+' : '-'}${t.amount}
                    </td>
                    <td style="font-size:0.8rem; color:#555; white-space:normal; max-width:150px;">
                        ${t.comment || '-'}
                    </td>
                    <td>
                        <button class="del-btn" onclick="delTrans(${t.id})">√ó</button>
                    </td>
                </tr>
            `;
        });

        // Update Stats
        document.getElementById('finBalance').innerText = `${total.toLocaleString()} ‚ÇΩ`;
        document.getElementById('finInc').innerText = `+${inc.toLocaleString()}`;
        document.getElementById('finExp').innerText = `-${exp.toLocaleString()}`;
    }

    function delTrans(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
            state.finance = state.finance.filter(t => t.id !== id);
            localStorage.setItem('finance_db', JSON.stringify(state.finance));
            renderFinance();
        }
    }

    // --- MODALS & ADDING ---
    function handleFab() {
        if(state.tab === 'habits') {
            document.getElementById('modal-habit').style.display = 'flex';
        } else {
            document.getElementById('modal-finance').style.display = 'flex';
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    function saveHabit() {
        const name = document.getElementById('hName').value;
        const goal = parseInt(document.getElementById('hGoal').value) || 30;
        if(name) {
            state.habits.push({ id: Date.now(), name, goal, checks: {} });
            localStorage.setItem('habits_db', JSON.stringify(state.habits));
            closeModal('modal-habit');
            document.getElementById('hName').value = '';
            renderHabits();
        }
    }

    function saveTransaction() {
        const amt = parseFloat(document.getElementById('fAmount').value);
        if(!amt) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
        
        const item = {
            id: Date.now(),
            type: document.getElementById('fType').value,
            amount: amt,
            category: document.getElementById('fCategory').value || '–†–∞–∑–Ω–æ–µ',
            comment: document.getElementById('fComment').value,
            date: document.getElementById('fDate').value || new Date().toISOString().split('T')[0]
        };
        
        state.finance.push(item);
        localStorage.setItem('finance_db', JSON.stringify(state.finance));
        
        closeModal('modal-finance');
        // Clear inputs
        document.getElementById('fAmount').value = '';
        document.getElementById('fCategory').value = '';
        document.getElementById('fComment').value = '';
        renderFinance();
    }

</script>

</body>
</html>
